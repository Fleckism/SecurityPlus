---
tags: [section]
---
# EXAM OBJECTIVES COVERED

3.3 Given a scenario, #Implementation  secure network designs #A_D #A_D

[[Intrusion]] detection and prevention systems are mature security technologies, widely deployed to monitor company networks. A large part of the monitoring and alerting data you will be analyzing will come from these systems so it is important that you be able to install them to appropriate locations in the network and configure them correctly.
# NETWORK-BASED INTRUSION DETECTION SYSTEMS

An **intrusion detection system** ([[IDS]]) is a means of using software tools to provide real-time analysis of either network traffic or system and application logs. A network-based IDS ([[NIDS]]) captures traffic via a packet sniffer, referred to as a sensor. It analyzes the packets to identify malicious traffic and displays alerts to a console or dashboard.

A NIDS, such as Snort ([snort.org](https://www.snort.org/)), Suricata ([suricata-ids.org](https://suricata-ids.org/)), or Zeek/Bro ([zeek.org](https://zeek.org/)) performs passive detection. When traffic is matched to a detection signature, it raises an alert or generates a log entry, but does not block the source host. This type of passive sensor does not slow down traffic and is undetectable by the attacker. It does not have an IP address on the monitored network segment.

A **NIDS is used to identify and log hosts and applications and to detect attack signatures, password guessing attempts, port scans, worms, backdoor applications, malformed packets or sessions, and policy violations (ports or IP addresses that are not permitted, for instance). You can use analysis of the logs to tune firewall rulesets, remove or block suspect hosts and processes from the network, or deploy additional [[security controls]] to mitigate any threats you identify.**

![Kibana dashboard showing a single alert of type "Possible Trojan Downloader"](https://s3.amazonaws.com/wmx-api-production/courses/5731/images/6926-1599771804743.png)

Viewing an intrusion detection alert generated by Snort in the Kibana app on Security Onion. (Screenshot Security Onion [securityonion.net](https://securityonion.net/).)
# TAPS AND PORT MIRRORS

Typically, the packet capture sensor is placed inside a firewall or close to a server of particular importance. The idea is usually to identify malicious traffic that has managed to **get past the firewall**. A single [[IDS]] can generate a very large amount of logging and alerting data so you cannot just put multiple sensors everywhere in the network without provisioning the resources to manage them properly. Depending on network size and resources, one or just a few sensors will be deployed to monitor key assets or network paths.

There are three main options for connecting a sensor to the appropriate point in the network:

-   [[SPAN]] (switched port analyzer)/mirror port—this means that the sensor is attached to a specially configured port on the switch that receives copies of frames addressed to nominated access ports (or all the other ports). This method is not completely reliable. **Frames with errors will not be mirrored and frames may be dropped under heavy load**.
-   **Passive** test access point ([[TAP]])—this is a box with ports for incoming and outgoing network cabling and an inductor or optical splitter that physically copies the signal from the cabling to a monitor port. There are types for copper and fiber optic cabling. **Unlike a SPAN, no logic decisions are made so the monitor port receives every frame—corrupt or malformed or not—and the copying is unaffected by load**.
-   **Active** TAP—this is a powered device that performs signal regeneration (again, there are copper and fiber variants), which may be necessary in some circumstances. Gigabit signaling over copper wire is too complex for a passive tap to monitor and some types of fiber links may be adversely affected by optical splitting. Because it performs an **active function**, the TAP becomes a point of failure for the links in the event of power loss. When deploying an active TAP, it is important to use a model with internal batteries or connect it to a UPS.

A TAP will usually output two streams to monitor a full-duplex link (one channel for upstream and one for downstream). Alternatively, there are aggregation TAPs, which rebuild the streams into a single channel, but these can drop frames under very heavy load.
# NETWORK-BASED INTRUSION PREVENTION SYSTEMS

Compared to the passive function of an [[IDS]], an intrusion prevention system ([[IPS]]) can provide an active response to any network threats that it matches. One typical preventive measure is to **end the TCP session, sending a TCP reset packet to the attacking host**. Another option is for the IPS to apply a temporary filter on the firewall to block the attacker's IP address (**shunning**). Other advanced measures include throttling bandwidth to attacking hosts, applying complex firewall filters, and even modifying suspect packets to render them harmless. Finally, the appliance may be able to run a script or third-party program to perform some other action not supported by the IPS software itself.

Some IPS provide inline, wire-speed antivirus scanning. Their rulesets can be configured to provide user content filtering, such as blocking URLs, applying keyword-sensitive block lists or allow lists, or applying time-based access restrictions.

IPS appliances are positioned like firewalls at the border between two network zones. As with proxy servers, the appliances are "inline" with the network, meaning that all traffic passes through them (also making them a single point-of-failure if there is no fault tolerance mechanism). This means that they need to be able to cope with high bandwidths and process each packet very quickly to avoid slowing down the network.
# SIGNATURE-BASED DETECTION

In an [[IDS]], the analysis engine is the component that scans and interprets the traffic captured by the sensor with the purpose of identifying suspicious traffic. The analysis engine determines how any given event should be classed, with typical options to ignore, log only, alert, and block ([[IPS]]). The analysis engine is programmed with a set of rules that it uses to drive its decision-making process. There are several methods of formulating the ruleset.

**Signature-based detection** (or pattern-matching) means that the engine is loaded with a database of attack patterns or signatures. If traffic matches a pattern, then the engine generates an incident.

![Sample Snort rules file shows many examples of tests for malicious content in the format "alert tcp $EXTERNAL_NET $Hyper Text Transfer ProtocolTTPs]]_PORTS -> $HOME_NET any (msg: ET ActiveX"](https://s3.amazonaws.com/wmx-api-production/courses/5731/images/7635-1599771804837.png)

Snort rules file supplied by the open-source Emerging Threats community feed.

The signatures and rules (often called plug-ins or feeds) powering intrusion detection need to be updated regularly to provide protection against the latest threat types. Commercial software requires a paid-for subscription to obtain the updates. It is important to ensure that the software is configured to update only from valid repositories, ideally using a secure connection method, such as Hyper Text Transfer ProtocolTTPs]]S.
# BEHAVIOR AND ANOMALY-BASED DETECTION

**Behavioral-based detection** means that the engine is trained to **recognize baseline** "normal" traffic or events. Anything that deviates from this baseline (outside a defined level of tolerance) generates an incident. The idea is that the software will be able to identify zero day attacks, insider threats, and other malicious activity for which there is no signature.

Historically, this type of detection was provided by network behavior and anomaly detection ([[NBAD]]) products. An NBAD engine uses heuristics to generate a statistical model of what baseline normal traffic looks like. It may develop several profiles to model network use at different times of the day. This means that the system generates false positive and false negatives until it has had time to improve its statistical model of what is "normal." A **false positive is where legitimate behavior generates an alert**, while a **false negative is where malicious activity is not alerted**.

While NBAD products were relatively unsophisticated, the use of machine learning in more recent products has helped to make them more productive. As identified by Gartner's market analysis ([gartner.com/en/documents/3917096/market-guide-for-user-and-entity-behavior-analytics](https://www.gartner.com/en/documents/3917096/market-guide-for-user-and-entity-behavior-analytics)), there are two general classes of behavior-based detection products that utilize machine learning:

-   User and entity behavior analytics ([[UEBA]])—these products scan indicators from multiple intrusion detection and log sources to identify anomalies. They are often integrated with security information and event management ([[SIEM]]) platforms.
-   Network traffic analysis ([[NTA]])—these products are closer to IDS and NBAD in that they apply analysis techniques only to network streams, rather than multiple network and log data sources.

Often behavioral- and anomaly-based detection are taken to mean the same thing (in the sense that the engine detects anomalous behavior). Anomaly-based detection can also be taken to mean specifically looking for irregularities in the use of protocols. For example, the engine may check packet headers or the exchange of packets in a session against RFC standards and generate an alert if they deviate from strict [[RFC]] compliance.
# NEXT-GENERATION FIREWALLS AND CONTENT FILTERS

While intrusion detection [[IDS]] was originally produced as standalone software or appliances, its functionality very quickly became incorporated into a new generation of firewalls. The original next-generation firewall ([[NGFW]]) was released as far back as 2010 by Palo Alto. This product combined application-aware filtering with user account-based filtering and the ability to act as an intrusion prevention system ([[IPS]]). This approach was quickly adopted by competitor products. Subsequent firewall generations have added capabilities such as cloud inspection and combined features of different security technologies.

### Unified Threat Management (UTM)

Unified threat management ([[UTM]]) refers to a security product that centralizes many types of **security controls—firewall, anti-malware, network intrusion prevention, spam filtering, content filtering, data loss prevention, VPN, cloud access gateway—into a single appliance**. This means that you can monitor and manage the controls from a single console. Nevertheless, UTM has some downsides. When defense is unified under a single system, this creates the potential for a single point of failure that could affect an entire network. Distinct security systems, if they fail, might only compromise that particular avenue of attack. Additionally, UTM systems can struggle with latency issues if they are subject to too much network activity. Also, a UTM might not perform as well as software or a device with a single dedicated security function.

To some extent, [[NGFW]] and UTM are **just marketing terms**. A UTM is seen as turnkey "do everything" solution, while a NGFW is an enterprise product with fewer features, or more modularization, and greater configuration complexity, but better performance. It can be more helpful to focus on the **specific product features,** rather than trying to present an implementation decision as a choice **of either a NGFW or a UTM**.

### Content/URL Filter

A firewall has to sustain high loads, and overloads can increase latency or even cause outages. The high complexity of application-aware [[NGFW]] and [[UTM]] solutions can **reduce their suitability as an [[network edge |edge device]]**, because while they might provide **high confidentiality and integrity, lower throughput reduces [[Availability]]**. One solution to this is to treat security solutions for server traffic differently from that for user traffic. User traffic refers to web browsing, social networking, email, and video/VoIP connections initiated by local network clients.

Consequently, where a stateful or NGFW [[firewall]] may be deployed for application server [[traffic]], the job of filtering user traffic is often performed by a separate appliance or proxy host. A content filter is designed to apply a number of user-focused filtering rules, such as blocking uniform resource locators (URLs) that appear on content block lists or applying time-based restrictions to browsing. Content filters are now usually implemented as a class of product called a secure web gateway ([[SWG]]). As well as filtering, a SWG performs threat analysis and often integrates the functionality of data loss prevention ([[DLP]]) and cloud access security brokers ([[CASB]]) to protect against the full range of unauthorized egress threats, including malware command and control and data exfiltration.
# HOST-BASED INTRUSION DETECTION SYSTEMS

A host-based [[IDS]] ([[HIDS]]) captures information from a single host, such as a server, router, or firewall. Some organizations may configure HIDS on each client workstation. HIDS come in many different forms with different capabilities. **The core ability is to capture and analyze #Ops log files**, but more sophisticated systems can also monitor OS kernel files, monitor ports and network interfaces, and process data and logs generated by specific applications, such as [[Hyper Text Transfer ProtocolTTPs]]]] or [[FTP]].

HIDS software produces similar output to an anti-malware scanner. If the software detects a threat, it may just log the event or display an alert. The log should show you which process initiated the event and what resources on the host were affected. You can use the log to investigate whether the suspect process is authorized or should be removed from the host.

One of the core features of HIDS is file integrity monitoring ([[FIM]]). This may also be implemented as a standalone feature. When software is installed from a legitimate source (using **signed code in the case of Windows** or a **secure repository in the case of Linux**), the OS package manager checks the signature or fingerprint of each executable file and notifies the user if there is a problem. FIM software audits key system files to make sure they match the authorized versions. In Windows, the Windows File Protection service runs automatically and the System File Checker ([[sfc]]) tool can be used manually to verify OS system files. Tripwire ([tripwire.com](https://www.tripwire.com/)) and OSSEC ([ossec.net](https://www.ossec.net/)) are examples of multi-platform tools with options to protect a wider range of applications.
# WEB APPLICATION FIREWALLS

A web application [[firewall]] ([[WAF]]) is designed specifically to protect software running on web servers and their back-end databases from code injection and DoS attacks. WAFs use application-aware processing rules to filter traffic and perform application-specific intrusion detection. The WAF can be programmed with signatures of known attacks and use pattern matching to block requests containing suspect code. The output from a WAF will be written to a log, which you can inspect to determine what threats the web application might be subject to.

![List of events shows Level, Date and Time, Source. “Friendly View” Details for Event 1 include “Request Indicates a Security Scanner Scanned the Site](https://s3.amazonaws.com/wmx-api-production/courses/5731/images/1447-1599771804958.png)

With the ModSecurity WAF installed to this IIS server, a scanning attempt has been detected and logged as an Application event. As you can see, the default ruleset generates a lot of events. (Screenshot used with permission from Microsoft.)

A WAF may be deployed as an appliance or as plug-in software for a web server platform. Some examples of WAF products include:

-   ModSecurity ([modsecurity.org](https://www.modsecurity.org/)) is an open source (sponsored by Trustwave) WAF for Apache, nginx, and IIS.
-   NAXSI ([github.com/nbs-system/naxsi](https://github.com/nbs-system/naxsi)) is an open source module for the nginx web server software.
-   Imperva ([imperva.com](https://www.imperva.com/)) is a commercial web security offering with a particular focus on data centers. Imperva markets WAF, DDoS, and database security through its SecureSphere appliance.
