# Lesson introduction
#zFleck 
Topic 4B

Analyze Indicators of Malware-Based Attacks

EXAM OBJECTIVES COVERED

1.2 Given a scenario, analyze potential indicators to determine the type of attack

4.1 Given a scenario, use the appropriate tool to assess organizational security (Cuckoo only)

One of the most prevalent threats to computers today is malicious code. As a security professional, you will likely have experience in dealing with unwanted software infecting your systems. **By classifying the various types of malware and identifying the signs of infection, you will be better prepared to remediate compromised systems or prevent malware from executing in the first place.**

# MALWARE CLASSIFICATION 

Many of the intrusion attempts perpetrated against computer networks depend on the use of malicious software, or [[malware]]. _Malware_ is usually simply defined as software that does something bad, from the perspective of the system owner. There are many types of malware, but they are not classified in a rigorous way, so some definitions overlap or are blurred. **Some malware classifications, such as Trojan, virus, and worm**, focus on the [[vector]] used by the malware. The **vector is the method by which the malware executes on a computer and potentially spreads to other network hosts**. Another complicating factor with malware classification is the degree to which its installation is expected or tolerated by the user. The following categories describe some **types of malware according to vector**:

-   **Viruses and worms**—these represent some of the first types of malware and spread without any authorization from the user by being concealed within the executable code of another process.
-   **[[Trojan]]**—malware concealed within an installer package for software that appears to be legitimate. This type of malware does not seek any type of consent for installation and is actively designed to operate secretly.
-   **Potentially unwanted programs** ([[PUPs]])/**Potentially unwanted applications** ([[PUAs]])—software installed alongside a package selected by the user or perhaps bundled with a new computer system. Unlike a Trojan, the presence of a PUP is not automatically regarded as malicious. It may have been installed without active consent or consent from a purposefully confusing license agreement. This type of software is sometimes described as **grayware** rather than malware.

Other classifications are based on the payload delivered by the malware. The [[payload]] is an action performed by the malware other than simply replicating or persisting on a host. Examples of payload classifications include spyware, rootkit, remote access Trojan (RAT), and ransomware.

Malware classification by vector. (Images © 123RF.com.)
# COMPUTER VIRUSES 

A [[computer virus]] is a type of malware designed to replicate and spread from computer to computer, usually by "infecting" executable applications or program code. There are several different types of viruses and they are generally classified by the different types of file or media that they infect:

-   **[[Non-resident_file infector]]**—the virus is contained within a host executable file and runs with the host process. The virus will try to infect other process images on persistent storage and perform other payload actions. It then passes control back to the host program.
-   **Memory resident**—when the host file is executed, the virus creates a new process for itself in memory. The malicious process remains in memory, even if the host process is terminated.
-   **Boot**—the virus code is written to the disk boot sector or the partition table of a fixed disk or USB media, and executes as a memory resident process when the OS starts or the media is attached to the computer.
-   **Script and macro viruses**—the malware uses the programming features available in local scripting engines for the OS and/or browser, such as PowerShell, Windows Management Instrumentation (WMI), JavaScript, Microsoft Office documents with Visual Basic for Applications (VBA) code enabled, or PDF documents with JavaScript enabled.

In addition, the term **multipartite** is used for viruses that use multiple vectors and **polymorphic** for viruses that can dynamically change or obfuscate their code to evade detection.

What these types of viruses have in common is that they must infect a host file or media. An infected file can be distributed through any normal means—on a disk, on a network, as an attachment to an email or social media post, or as a download from a website.

![Email shows Outlook blocked access to an attached file with a long, numerical name that begins "Docx" and ends "PDF.jar."](https://s3.amazonaws.com/wmx-api-production/courses/5731/images/1823-1599771796477.png)

Unsafe attachment detected by Outlook's mail filter—The "double" file extension is an unsophisticated attempt to fool any user not already alerted by the use of both English and another language in the message text. (Screenshot used with permission from Microsoft.)
# COMPUTER WORMS AND FILELESS MALWARE

A computer worm is memory-resident [malware] that can run without user intervention and replicate over network resources. **A virus is executed only when the user performs an action** such as downloading and running an infected executable process, attaching an infected USB stick, or opening an infected Word document with macros enabled. By contrast, a [[worm]] **can execute by exploiting a vulnerability in a process when the user browses a website, runs a vulnerable server application**, or is connected to an infected file share. For example, the Code-Red worm was able to infect early versions of Microsoft's IIS web server software via a buffer overflow vulnerability. It then scanned randomly generated IP ranges to try to infect other vulnerable IIS servers ([caida.org/research/security/code-red](https://www.caida.org/research/security/code-red/)).

The primary effect of the first types of computer worm is to rapidly consume network bandwidth as the worm replicates. A worm may also be able to crash an operating system or server application (performing a Denial of Service attack[[DoS]]). Also, like viruses, worms can carry a payload that may perform some other malicious action. 

The Conficker worm illustrated the potential for remote code execution and memory-resident malware to effect highly potent attacks ([secureworks.com/research/downadup-removal](https://www.secureworks.com/research/downadup-removal)). As malware continues to be developed for criminal intent and security software becomes more able to detect and block static threats, malware code and techniques have become more sophisticated. The term _fileless_ has gained prominence to refer to these modern types of malware. [[Fileless]] is not a definitive classification, but it describes a collection of common behaviors and techniques:

-   Fileless [[malware]] does not write its code to disk. The malware uses memory resident techniques to run in its own process, within a host process or dynamic link library ([[DLL]]), or within a scripting host. This does not mean that there is no disk activity at all, however. The malware may change registry values to achieve persistence (executing if the host computer is restarted). The initial execution of the malware may also depend on the user running a downloaded script, file attachment, or Trojan software package.
-   Fileless malware uses lightweight shellcode to achieve a [[backdoor]] mechanism on the host. The shellcode is easy to recompile in an obfuscated form to evade detection by scanners. It is then able to download additional packages or payloads to achieve the actor's actions and/or objectives. These packages can also be obfuscated, streamed, and compiled on the fly to evade automated detection.
-   Fileless malware may use "live off the land" techniques rather than compiled executables to evade detection. This means that the malware code uses legitimate system scripting tools, notably PowerShell and Windows Management Instrumentation (WMI), to execute payload actions. If they can be executed with sufficient permissions, these environments provide all the tools the attacker needs to perform scanning, reconfigure settings, and exfiltrate data.

The terms _advanced persistent threat ([[APT]])_ and _advanced volatile threat (AVT)_ can be used to describe this general class of modern fileless/live off the land malware. Another useful classification is low observable characteristics ([[LOC]]) attack ([mcafee.com/enterprise/en-us/security-awareness/ransomware/what-is-fileless-malware.html](https://www.mcafee.com/enterprise/en-us/security-awareness/ransomware/what-is-fileless-malware.html)). The exact classification is less important than the realization that adversaries can use any variety of coding tricks to effect intrusions and that their tactics, techniques, and procedures to evade detection are continually evolving.

# [[SPYWARE]] AND KEYLOGGERS

The first viruses and worms focused on the destructive potential of being able to replicate. As the profitable uses of this software became apparent, however, they started to be coded with payloads designed to facilitate intrusion, fraud, and data theft. Various types of unwanted code and malware perform some level of monitoring:

-   Tracking cookies—cookies are plaintext files, not malware, but if browser settings allow third-party cookies, they can be used to record pages visited, search queries, browser metadata, and IP address. Tracking cookies are created by adverts and analytics widgets embedded into many websites.
-   Adware—this is a class of [[PUPs]]/grayware that performs browser reconfigurations, such as allowing tracking cookies, changing default search providers, opening sponsor's pages at startup, adding bookmarks, and so on. Adware may be installed as a program or as a browser extension/plug-in.
-   Spyware—this is malware that can perform adware-like tracking, but also monitor local application activity, take screenshots, and activate recording devices, such as a microphone or webcam. Another spyware technique is to perform [[DNS]] redirection to pharming sites.
-   A keylogger is spyware that actively attempts to steal confidential information by recording keystrokes. The attacker will usually hope to discover passwords or credit card data.

![Screenshot of Actual Keylogger shows detail on Keystrokes tab, including actual password typed for highlighted item.](https://s3.amazonaws.com/wmx-api-production/courses/5731/images/1811-1599771796602.png)

Actual Keylogger is a Windows-based software that can run in the background to monitor different kinds of computer activity (opening and closing programs, browsing websites, recording keystrokes, and capturing screenshots). (Screenshot used with permission from [ActualKeylogger.com](https://www.actualkeylogger.com/).)

Keyloggers are not only implemented as software. A malicious script can transmit key presses to a third-party website. There are also hardware devices to capture key presses to a modified USB adapter inserted between the keyboard and the port. Such devices can store data locally or come with Wi-Fi connectivity to send data to a covert access point. Other attacks include wireless sniffers to record key press data, overlay ATM pin pads, and so on.

# BACKDOORS AND REMOTE ACCESS TROJANS

Any type of access method to a host that circumvents the usual authentication method and gives the remote user administrative control can be referred to as a [[backdoor]]. A remote access trojan ([[RAT]]) is backdoor malware that mimics the functionality of legitimate remote control programs, but is designed specifically to operate covertly. Once the RAT is installed, it allows the threat actor to access the host, upload files, and install software or use "live off the land" techniques to effect further compromises. 

In this context, RAT can also stand for Remote Administration Tool. A host that is under malicious control is sometimes described as a zombie.

A compromised host can be installed with one or more bots. A [[bot]] is an automated script or tool that performs some malicious activity. A group of bots that are all under the control of the same malware instance can be manipulated as a botnet by the herder program. A [[botnet]] can be used for many types of malicious purpose, including triggering distributed denial of service (DDoS) attacks, launching spam campaigns, or performing cryptomining.

![Screenshot showing connection server options, including change port, set default port, set or remove password, disconnect victim, and restart server.](https://s3.amazonaws.com/wmx-api-production/courses/5731/images/8071-1599771796742.png)

SubSeven RAT. (Screenshot used with permission from Wikimedia Commons by CCAS4.0 International.)

Whether a backdoor is used as a standalone intrusion mechanism or to manage bots, the threat actor must establish a connection from the compromised host to a command and control ([[C2]] or [[C&C]]) host or network. This network connection is usually the best way to identify the presence of a RAT, backdoor, or bot. There are many means of implementing a C&C network as a covert channel to evade detection and filtering. Historically, the Internet relay chat (IRC) protocol was popular. Modern methods are more likely to use command sequences embedded in HTTPS or DNS traffic. 

Backdoors can be created in other ways than infection by [[malware]]. Programmers may create backdoors in software applications for testing and development that are subsequently not removed when the application is deployed. [[Backdoor]]s are also created by misconfiguration of software or hardware that allows access to unauthorized users. Examples include leaving a router configured with the default administrative password, having a Remote Desktop connection configured with an unsecure password, or leaving a modem open to receive dial-up connections.

# ROOTKITS

In Windows, [[malware]] can only be manually installed with local administrator privileges. This means the user must be confident enough in the installer package to enter the credentials or accept the User Account Control ([[UAC]]) prompt. Windows tries to protect the system from abuse of administrator privileges. Critical processes run with a higher level of privilege (SYSTEM). Consequently, [[Trojan]]s installed in the same way as regular software cannot conceal their presence entirely and will show up as a running process or service. Often the process image name is configured to be similar to a genuine executable or library to avoid detection. For example, a Trojan may use the filename "run32d11" to masquerade as "run32dll". To ensure persistence (running when the computer is restarted), the [[Trojan]] may have to use a **registry entry or create itself as a service, which can usually be detected fairly easily.**
#z 
If the malware can be delivered as the payload for an exploit of a severe vulnerability, it may be able to execute without requiring any authorization using SYSTEM privileges. Alternatively, the malware may be able to use an exploit to escalate privileges after installation. Malware running with this level of privilege is referred to as a [[rootkit]]. The term derives from UNIX/Linux where any process running as root has unrestricted access to everything from the root of the file system down. 

In theory, there is nothing about the system that a rootkit could not change. In practice, Windows uses other mechanisms to prevent misuse of kernel processes, such as code signing ([microsoft.com/security/blog/2017/10/23/hardening-the-system-and-maintaining-integrity-with-windows-defender-system-guard](https://www.microsoft.com/security/blog/2017/10/23/hardening-the-system-and-maintaining-integrity-with-windows-defender-system-guard/)). **Consequently, what a rootkit can do depends largely on adversary capability and level of effort. When dealing with a rootkit, you should be aware that there is the possibility that it can compromise system files and programming interfaces, so that local shell processes, such as Explorer, taskmgr, or tasklist on Windows or ps or top on Linux, plus port listening tools, such as netstat, no longer reveals its presence (at least, if run from the infected machine). A rootkit may also contain tools for cleaning system logs, further concealing its presence** ([microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Win32%2fCutwail](https://www.microsoft.com/en-us/wdsi/threats/malware-encyclopedia-description?Name=Win32%2fCutwail)). 

Software processes can run in one of several "rings." Ring 0 is the most privileged (it provides direct access to hardware) and so should be reserved for kernel processes only. Ring 3 is where user-mode processes run; drivers and I/O processes may run in Ring 1 or Ring 2. This architecture can also be complicated by the use of virtualization.

There are also examples of rootkits that can reside in firmware (either the computer firmware or the firmware of any sort of adapter card, hard drive, removable drive, or peripheral device). These can survive any attempt to remove the rootkit by formatting the drive and reinstalling the OS. For example, the US intelligence agencies have developed DarkMatter and QuarkMatter EFI rootkits targeting the firmware on Apple Macbook laptops ([pcworld.com/article/3179348/after-cia-leak-intel-security-releases-detection-tool-for-efi-rootkits.html](https://pcworld.com/article/3179348/after-cia-leak-intel-security-releases-detection-tool-for-efi-rootkits.html)).

# RANSOMWARE, CRYPTO-MALWARE, AND LOGIC BOMBS

[[Ransomware]] is a type of [[malware]] that tries to extort money from the victim. One class of ransomware will display threatening messages, such as requiring Windows to be reactivated or suggesting that the computer has been locked by the police because it was used to view child pornography or for terrorism. This may apparently block access to the file system by installing a different shell program, but this sort of attack is usually relatively simple to fix.

![Screenshot with countdown clock notifies user that files have been encrypted and includes bitcoin address with buttons "Check Payment" and "Decrypt."](https://s3.amazonaws.com/wmx-api-production/courses/5731/images/1015-1599771796804.png)

WannaCry ransomware. (Image by Wikimedia Commons.)

The crypto-malware class of ransomware attempts to encrypt data files on any fixed, removable, and network drives. If the attack is successful, the user will be unable to access the files without obtaining the private encryption key, which is held by the attacker. If successful, this sort of attack is extremely difficult to mitigate, unless the user has up to date backups of the encrypted files. One example of this is Cryptolocker, a Trojan that searches for files to encrypt and then prompts the victim to pay a sum of money before a certain countdown time, after which the malware destroys the key that allows the decryption.

Ransomware uses payment methods, such as wire transfer, cryptocurrency, or premium rate phone lines, to allow the attacker to extort money without revealing his or her identity or being traced by local law enforcement.

Another type of crypto-malware hijacks the resources of the host to perform cryptocurrency mining. This is referred to as _crypto-mining_ or _cryptojacking._ The total number of coins within a cryptocurrency is limited by the difficulty of performing the calculations necessary to mint a new digital coin. Consequently, new coins can be very valuable, but it takes enormous computing resources to discover them. Cryptojacking is often performed across botnets.

The word "crypto" in crypto-malware comes from the word "cryptography" and not from "cryptocurrency".

Some types of malware do not trigger automatically. Having infected a system, they wait for a pre-configured time or date (time bomb) or a system or user event ([[logic bomb]]). A logic bomb isn't necessarily malicious code but could be an event that triggers an undesirable event. A typical example is a disgruntled system administrator who leaves a scripted trap that runs in the event his or her account is deleted or disabled. Anti-virus software is unlikely to detect this kind of malicious script or program. This type of trap is also referred to as a _mine._

# MALWARE INDICATORS

Given the range of malware types, there are many potential indicators. Some types of [[malware]] display obvious changes, such as adjusting browser settings or displaying ransom notices. If malware is designed to operate covertly, indicators can require detailed analysis of process, file system, and network behavior.

### Antivirus Notifications

Most hosts should be running some type of antivirus ([[A-V]]) software. While the A-V moniker remains popular, these suites are better conceived of as endpoint protection platforms ([[EPPs]]) or next-gen A-V. These detect malware by signature regardless of type, though detection rates can vary quite widely from product to product. Many suites also integrate with user and entity behavior analytics ([[UEBA]]) and use AI-backed analysis to detect threat actor behavior that has bypassed malware signature matching.

### Sandbox Execution

If it is not detected by endpoint protection, you may want to analyze the suspect code in a sandboxed environment. A [[sandbox]] is a system configured to be completely isolated from its host so that the malware cannot "break out." The sandbox will be designed to record file system and registry changes plus network activity. Cuckoo is packaged software that aims to provide a turnkey sandbox solution ([cuckoosandbox.org](https://cuckoosandbox.org/)).

### Resource Consumption

Abnormal resource consumption can be detected using a performance monitor, Task Manager, or the top Linux utility. Indicators such as excessive and continuous CPU usage, memory leaks, disk read/write activity, and disk space usage can be signs of malware, but can also be caused by many other performance and system stability issues. Also, it is only really poorly written malware or [[malware]] that performs intensive operations (botnet DDoS, cryptojacking, and cryptoransomware, for instance) that displays this behavior. Resource consumption could be a reason to investigate a system rather than definitive proof of infection.

### File System

While fileless malware is certainly prevalent, file system change or anomaly analysis is still necessary. Even if the [[malware]] code is not saved to disk, the malware is still likely to interact with the file system and registry, revealing its presence by behavior. A computer's file system stores a great deal of useful metadata about when files were created, accessed, or modified. Analyzing these metadata and checking for suspicious temporary files can help you establish your timeline of events for an incident that has left traces on a host and its files.

Explorer showing regular process hierarchy in Windows 10 v1909. (Screenshot used with permission from Microsoft.)

# PROCESS ANALYSIS

Because shellcode is easy to obfuscate, it can often evade signature-based [[A-V]] products. Threat hunting and security monitoring must use **behavioral-based techniques** to identify infections. This means close analysis of the processes running in system memory on a host. To perform abnormal process behavior analysis effectively, you should build up a sense of what is "normal" in a system and spot deviations in a potentially infected system. You also need to use appropriate analysis tools. Sysinternals ([docs.microsoft.com/en-us/sysinternals](https://docs.microsoft.com/en-us/sysinternals/)) is a suite of tools designed to assist with troubleshooting issues with Windows, and many of the tools are suited to investigating security issues. The Sysinternals tool Process Explorer is an enhanced version of Task Manager. You can view extra information about each process and better understand how processes are created in parent/child relationships.

In this example, the Metasploit Framework is being used to obtain access via a remotely executed PowerShell prompt, with privileges obtained by passing a captured hash. This attack leverages the Sysinternals PsExec utility to drop a service executable into the Admin$ share on the remote machine. In this variant of the attack, the service starts PowerShell. Pointing to the powershell.exe image in Process Explorer shows the parameters that the process launched with. In this case, the command used to start this is not typical of PowerShell usage. There is a long string of characters, which is binary code represented in Base64. The script is injecting this into a new DLL, stored in memory only.

![](https://s3.amazonaws.com/wmx-api-production/courses/5731/images/96-1599771796920.png)

Observing use of PsExec to invoke a PowerShell script that creates memory-resident shellcode. (Screenshot: Process Explorer [docs.microsoft.com/en-us/sysinternals](https://docs.microsoft.com/en-us/sysinternals).)

This sort of behavior can only be observed in real-time when the malware is executed in a sandbox. Threat hunting and automated detection tools can use detailed logging, such as that provided by System Monitor ([github.com/SwiftOnSecurity/sysmon-config](https://github.com/SwiftOnSecurity/sysmon-config)), to record and identify malicious process behavior.

**Along with observing how a process interacts with the file system, network activity is one of the most reliable ways to identify [[malware]].** Threat data can be used to correlate connections to known-bad IP addresses and domains, but malware may try to connect to continually shifting endpoints, utilizing techniques such as fast-flux and domain generation algorithms ([[DGA]]). It may try to use social media and cloud services to blend in with legitimate traffic.